# User Profiles Schema Migration Plan

## Problem Statement

The current `user_profiles` table has several issues affecting reliability and maintainability:

1. **Insert Failures**: The `id` column (TEXT) is not auto-generated, requiring manual UUID generation in application code. This causes insert failures when IDs are missing or null.
2. **Schema Complexity**: 100+ individual columns for personality traits, appearance attributes, and behavioral metrics make the table unwieldy.
3. **Inconsistent Types**: While timestamps are correctly stored as BIGINT epoch seconds (consistent with other tables), the manual ID generation is error-prone.

## Migration Strategy: Phased Approach

To minimize risk and ensure backward compatibility, this migration is split into two phases.

---

## Phase 1: Fix ID Auto-Generation (THIS PR)

**Goal**: Enable auto-generation of the `id` column to prevent insert failures.

**Changes**:
- Add `DEFAULT gen_random_uuid()::text` to the existing `id` column
- No schema structure changes
- No data migration required
- Fully backward compatible

**Benefits**:
- Fixes insert failures immediately
- Application code continues to work as-is
- Can optionally simplify application code later by removing manual UUID generation
- Low risk, high impact fix

**Migration Script**: `packages/database/scripts/fix-user-profiles-id-generation.sh`

**Application Code Changes** (Optional):
The code in `packages/database/src/postgres/userProfileService.ts` can be simplified:

```typescript
// BEFORE (current - still works):
const id = randomUUID();
await prisma.userProfile.create({
  data: {
    id,  // manually generated
    userId,
    username,
    // ...
  },
});

// AFTER (optional optimization):
await prisma.userProfile.create({
  data: {
    // id is auto-generated by database
    userId,
    username,
    // ...
  },
});
```

---

## Phase 2: Normalize Schema with JSONB (FUTURE PR)

**Goal**: Consolidate related columns into JSONB for better maintainability and flexibility.

**Proposed Schema**:

```sql
CREATE TABLE user_profiles_v2 (
  -- Core identification
  id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  user_id TEXT UNIQUE NOT NULL,  -- Discord user ID
  username TEXT NOT NULL,

  -- Timestamps (keep as BIGINT for consistency)
  first_seen_at BIGINT NOT NULL,
  last_interaction_at BIGINT NOT NULL,
  last_analyzed_at BIGINT,
  last_photo_analyzed_at BIGINT,
  created_at BIGINT DEFAULT (EXTRACT(epoch FROM now()))::bigint,
  updated_at BIGINT DEFAULT (EXTRACT(epoch FROM now()))::bigint,

  -- Metrics
  message_count INTEGER DEFAULT 0,

  -- User-editable fields
  avatar_url TEXT,
  bio TEXT,
  preferences JSONB,

  -- Grouped psychological traits
  personality_traits JSONB,  -- Big Five, archetypes, attachment style, etc.

  -- Grouped appearance attributes
  appearance_traits JSONB,    -- face, hair, eyes, body type, etc.

  -- Grouped behavioral metrics
  behavioral_metrics JSONB,   -- communication style, emoji usage, etc.

  -- Grouped cultural/astrological data
  cultural_attributes JSONB,  -- cultural background, zodiac, etc.

  -- Analysis and predictions
  analysis_summary JSONB,     -- affinity, trust, predictions, etc.

  -- Metadata
  metadata JSONB
);

-- Indexes for performance
CREATE INDEX idx_user_profiles_user_id ON user_profiles_v2(user_id);
CREATE INDEX idx_user_profiles_last_analyzed ON user_profiles_v2(last_analyzed_at);
CREATE INDEX idx_user_profiles_preferences_gin ON user_profiles_v2 USING GIN (preferences);
CREATE INDEX idx_user_profiles_personality_gin ON user_profiles_v2 USING GIN (personality_traits);
CREATE INDEX idx_user_profiles_appearance_gin ON user_profiles_v2 USING GIN (appearance_traits);
CREATE INDEX idx_user_profiles_behavioral_gin ON user_profiles_v2 USING GIN (behavioral_metrics);
```

**JSONB Structure Examples**:

```javascript
// personality_traits
{
  "archetypes": {
    "dominant": "The Hero",
    "secondary": ["The Sage", "The Creator"],
    "shadow": "The Destroyer",
    "confidence": 0.85
  },
  "bigFive": {
    "openness": 75,
    "conscientiousness": 60,
    "extraversion": 80,
    "agreeableness": 70,
    "neuroticism": 40
  },
  "attachmentStyle": "secure",
  "attachmentConfidence": 0.75,
  "emotionalIntelligence": {
    "awareness": 8,
    "empathy": 9,
    "regulation": 7
  }
}

// appearance_traits
{
  "uploadedPhotoUrl": "https://...",
  "aiDescription": "Athletic build with...",
  "confidence": 0.90,
  "demographics": {
    "detectedGender": "male",
    "genderConfidence": 0.85,
    "ageRange": "25-35",
    "ageConfidence": 0.70
  },
  "facial": {
    "shape": "oval",
    "symmetryScore": 8,
    "jawlineProminence": "strong",
    "cheekboneProminence": "moderate"
  },
  "hair": {
    "color": "brown",
    "texture": "wavy",
    "length": "short",
    "style": "messy",
    "density": "thick",
    "facial": "beard"
  },
  "eyes": {
    "color": "blue",
    "shape": "almond",
    "spacing": "average"
  },
  "physical": {
    "bodyType": "athletic",
    "buildDescription": "muscular",
    "heightEstimate": "6'0\"",
    "posture": "upright"
  }
}

// behavioral_metrics
{
  "communication": {
    "formality": "casual",
    "assertiveness": "high",
    "engagement": "active",
    "verbalFluency": 8,
    "questionFrequency": 0.15
  },
  "thinking": {
    "analyticalScore": 8,
    "creativeScore": 7,
    "abstractReasoning": 9,
    "concreteThinking": 6
  },
  "social": {
    "dominanceScore": 7,
    "cooperationScore": 8,
    "conflictStyle": "collaborative",
    "humorStyle": "witty"
  },
  "messaging": {
    "avgLength": 150.5,
    "lengthVariance": 45.2,
    "responseLatency": 30.5,
    "emojiUsageRate": 0.25,
    "punctuationStyle": "moderate",
    "capitalizationPattern": "standard"
  },
  "interests": {
    "primary": ["technology", "music", "gaming"],
    "expertise": ["javascript", "databases", "devops"],
    "technicalLevel": "advanced"
  }
}
```

**Migration Steps for Phase 2**:

1. Create new columns with JSONB types
2. Write data migration script to transform individual columns into JSONB
3. Create database function to map old columns to new JSONB structure
4. Test migration on copy of production data
5. Update application code to use new JSONB structure
6. Run migration on production with transaction
7. Drop old individual columns after verification period
8. Update Prisma schema and regenerate client

**Benefits of Phase 2**:
- More maintainable schema
- Easier to extend with new attributes
- Better query performance with GIN indexes
- Cleaner application code
- Follows PostgreSQL best practices for semi-structured data

---

## Timeline

- **Phase 1**: Immediate (this PR)
- **Phase 2**: Future PR, after Phase 1 is tested in production

## Rollback Plan

**Phase 1 Rollback**:
```sql
ALTER TABLE user_profiles ALTER COLUMN id DROP DEFAULT;
```

**Phase 2 Rollback**:
- Keep old columns during initial deployment
- Can revert to old columns if issues arise
- Only drop old columns after verification period

## Testing Strategy

**Phase 1**:
1. Run migration on development database
2. Test inserts without specifying ID
3. Verify existing code still works
4. Run type-check and build
5. Deploy to production

**Phase 2** (future):
1. Create test database with copy of production data
2. Run migration and verify data integrity
3. Test all application code with new schema
4. Performance test JSONB queries vs individual columns
5. Gradual rollout with monitoring

---

## Related Files

- Migration script: `packages/database/scripts/fix-user-profiles-id-generation.sh`
- User profile service: `packages/database/src/postgres/userProfileService.ts`
- Schema types: `packages/database/src/postgres/schema.ts`
- Prisma schema: `packages/database/prisma/schema.prisma`

## References

- Issue: #927
- CLAUDE.md database guidelines
- PostgreSQL UUID documentation: https://www.postgresql.org/docs/current/datatype-uuid.html
- PostgreSQL JSONB best practices: https://www.postgresql.org/docs/current/datatype-json.html
