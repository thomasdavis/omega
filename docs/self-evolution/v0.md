# Self-Evolution v0: Infrastructure & Safety Rails

## Overview

The Self-Evolution system enables Omega to autonomously propose and implement capability improvements while maintaining strict safety guardrails. Version 0 establishes the foundational infrastructure, database schema, scheduling, and safety mechanisms.

## Architecture

### Components

1. **Scheduler** (`self-evolution.yml`)
   - Runs daily at 02:00 UTC
   - Applies random jitter (±20 minutes)
   - Exclusive lock via database
   - Skips during active deployments

2. **Database Schema**
   - `self_evolution_runs` - Execution records
   - `self_evolution_reflections` - Analysis and insights
   - `self_evolution_proposals` - Candidate changes
   - `self_evolution_actions` - Concrete actions taken
   - `self_evolution_rollbacks` - Rollback history
   - `feature_flags` - Feature flag store

3. **Safety Rails**
   - Allowlist/blocklist path enforcement
   - Diff caps (≤500 LOC, ≤10 files)
   - CI required checks
   - Risk level validation
   - Auto-revert on failure

4. **Telemetry**
   - All runs logged to database
   - Artifacts uploaded to GitHub Actions
   - 90-day retention
   - Full audit trail

## Configuration

Configuration is stored in `.github/self-evolution-config.json`:

```json
{
  "enabled": false,
  "dryRunMode": true,
  "safetyRails": {
    "diffCaps": {
      "maxLinesOfCode": 500,
      "maxFilesChanged": 10
    },
    "allowedPaths": [...],
    "blockedPaths": [...]
  }
}
```

### Feature Flag

The system is controlled by a database feature flag:

```sql
-- Enable self-evolution
INSERT INTO feature_flags (key, value, metadata)
VALUES ('self_evolution_enabled', true, '{"enabledAt": "2025-12-05", "enabledBy": "admin"}')
ON CONFLICT (key) DO UPDATE SET value = true;

-- Disable self-evolution
UPDATE feature_flags SET value = false WHERE key = 'self_evolution_enabled';
```

## Safety Mechanisms

### 1. Diff Caps
- Maximum 500 lines of code changed per PR
- Maximum 10 files modified per PR
- Enforced at proposal validation stage

### 2. Path Controls
**Allowed Paths:**
- `packages/agent/src/tools/**` - New tools
- `packages/agent/src/prompts/**` - Prompt updates
- `apps/bot/src/persona/**` - Persona adjustments
- `docs/**/*.md` - Documentation
- `.github/self-evolution-config.json` - Self-config

**Blocked Paths:**
- `.github/workflows/**` - No workflow changes
- `packages/database/**` - No database changes
- `.env*` - No secrets
- `pnpm-lock.yaml` - No dependency changes

### 3. Risk Levels
- **0-1:** Low risk (typos, docs, minor persona tweaks)
- **2-3:** Medium risk (new tools, prompt changes)
- **4-5:** High risk (not allowed in v0)

Maximum allowed risk: **2** (or **1** for wildcard)

### 4. CI Enforcement
- All PRs must have green CI checks
- Type-check must pass
- Build must succeed
- No force-push allowed

### 5. Exclusive Lock
Only one self-evolution run per day. The scheduler:
1. Checks if today's run exists in `self_evolution_runs`
2. Creates a new record with status `running`
3. Acquires lock via database transaction
4. Skips if lock cannot be acquired

### 6. Deployment Detection
Skips execution if any of these are true:
- Active CI workflow running
- Railway deployment in progress
- Previous run failed (24h cooldown)

## Workflow Lifecycle

### 1. Schedule Trigger
```
02:00 UTC daily (cron: '0 2 * * *')
↓
Random jitter (0-20 minutes)
↓
Check feature flag
```

### 2. Pre-flight Checks
```
Feature flag enabled? → No → Exit
↓ Yes
Active deployments? → Yes → Exit
↓ No
Can acquire lock? → No → Exit
↓ Yes
Proceed to execution
```

### 3. Execution (v0)
```
Create run record
↓
[TODO: Reflection logic - future iteration]
↓
[TODO: Proposal generation - future iteration]
↓
[TODO: Action execution - future iteration]
↓
Update run status
↓
Upload artifacts
```

### 4. Post-execution
```
Upload artifacts to GitHub Actions (90-day retention)
↓
Update database records
↓
Generate workflow summary
```

## Database Schema

### self_evolution_runs
Tracks each daily execution.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| run_date | DATE | Execution date (unique) |
| status | VARCHAR | planned, running, success, failed, reverted |
| started_at | TIMESTAMPTZ | Run start time |
| finished_at | TIMESTAMPTZ | Run end time |
| summary | TEXT | Human-readable summary |
| logs_url | TEXT | Link to artifacts/logs |
| metrics | JSONB | Performance metrics |

### self_evolution_reflections
Stores insights from each run.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| run_id | INTEGER | FK to self_evolution_runs |
| insights | TEXT | Analysis and observations |
| sentiment | JSONB | Sentiment data |
| created_at | TIMESTAMPTZ | Creation time |

### self_evolution_proposals
Candidate changes proposed by the system.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| run_id | INTEGER | FK to self_evolution_runs |
| type | VARCHAR | capability, prompt, persona, cleanup, wildcard |
| title | TEXT | Proposal title |
| description | TEXT | Detailed description |
| risk_level | SMALLINT | 0-5 risk score |
| effort | SMALLINT | 0-5 effort score |
| allowlisted | BOOLEAN | Passed allowlist check |
| blocked_reasons | TEXT[] | Why blocked (if applicable) |
| created_at | TIMESTAMPTZ | Creation time |

### self_evolution_actions
Concrete actions taken (PRs, issues, etc.).

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| proposal_id | INTEGER | FK to self_evolution_proposals |
| action_type | VARCHAR | issue, pr, prompt_change, etc. |
| payload | JSONB | Action-specific data |
| status | VARCHAR | planned, submitted, merged, rolled_back |
| created_at | TIMESTAMPTZ | Creation time |
| updated_at | TIMESTAMPTZ | Last update time |

### self_evolution_rollbacks
Rollback records for failed actions.

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| action_id | INTEGER | FK to self_evolution_actions |
| reason | TEXT | Why rolled back |
| created_at | TIMESTAMPTZ | Rollback time |

### feature_flags
Generic feature flag store.

| Column | Type | Description |
|--------|------|-------------|
| key | TEXT | Flag name (PK) |
| value | BOOLEAN | Enabled/disabled |
| metadata | JSONB | Additional data |
| created_at | TIMESTAMPTZ | Creation time |

## Rollout Plan

### Phase 1: Infrastructure (Current - v0)
- ✅ Database schema created
- ✅ Workflow file created
- ✅ Safety rails configured
- ✅ Feature flag defaults to OFF
- ✅ Dry-run mode by default

### Phase 2: Dry-Run Testing (48 hours)
1. Enable feature flag in database
2. Monitor daily runs in dry-run mode
3. Verify no policy violations
4. Review telemetry data
5. Confirm artifacts are uploaded correctly

### Phase 3: Staged Enablement
1. Disable dry-run mode for wildcard feature only
2. Allow one small reversible change per day
3. Monitor for 7 days
4. If stable, gradually enable other change types

### Phase 4: Full Enablement
1. Enable all change types (capability, prompt, persona, cleanup)
2. Keep max risk level at 2
3. Maintain diff caps
4. Continue monitoring

## Wildcard Feature

The "wildcard" is a special change type that allows one small, reversible, low-risk change per day.

**Constraints:**
- Risk level ≤ 1 (low risk only)
- Only persona or prompt changes
- Must be easily reversible
- Examples: typo fixes, persona tone adjustments, doc updates

**Purpose:**
- Test the system with minimal risk
- Build confidence in safety rails
- Demonstrate autonomous capability

## Monitoring & Observability

### Database Queries

**Check recent runs:**
```sql
SELECT id, run_date, status, summary, started_at, finished_at
FROM self_evolution_runs
ORDER BY run_date DESC
LIMIT 10;
```

**View proposals for a run:**
```sql
SELECT p.id, p.type, p.title, p.risk_level, p.effort, p.allowlisted
FROM self_evolution_proposals p
WHERE p.run_id = 123
ORDER BY p.created_at DESC;
```

**Check actions and status:**
```sql
SELECT a.id, a.action_type, a.status, p.title AS proposal_title
FROM self_evolution_actions a
JOIN self_evolution_proposals p ON a.proposal_id = p.id
WHERE a.status != 'rolled_back'
ORDER BY a.created_at DESC;
```

**Feature flag status:**
```sql
SELECT key, value, metadata, created_at
FROM feature_flags
WHERE key = 'self_evolution_enabled';
```

### GitHub Actions

View runs at: `.github/workflows/self-evolution.yml`

**Manual trigger:**
1. Go to Actions → Self-Evolution - Daily Capability Development
2. Click "Run workflow"
3. Select options:
   - Dry run: true/false
   - Force run: true/false

**Artifacts:**
- Stored for 90 days
- Include logs, proposals, and analysis
- Downloadable from workflow run page

## Troubleshooting

### System Not Running

**Check feature flag:**
```sql
SELECT * FROM feature_flags WHERE key = 'self_evolution_enabled';
```

**Verify workflow file:**
```bash
cat .github/workflows/self-evolution.yml
```

**Check recent runs:**
```sql
SELECT * FROM self_evolution_runs ORDER BY run_date DESC LIMIT 5;
```

### Runs Failing

**Check workflow logs:**
- Go to GitHub Actions
- Find failed self-evolution run
- Review step logs

**Check database status:**
```sql
SELECT id, run_date, status, summary
FROM self_evolution_runs
WHERE status = 'failed'
ORDER BY run_date DESC;
```

**Review rollback records:**
```sql
SELECT r.*, a.action_type
FROM self_evolution_rollbacks r
JOIN self_evolution_actions a ON r.action_id = a.id
ORDER BY r.created_at DESC;
```

### Stuck in "running" Status

If a run is stuck (status = 'running' but finished):

```sql
UPDATE self_evolution_runs
SET status = 'failed',
    finished_at = NOW(),
    summary = 'Manually marked as failed due to stuck state'
WHERE id = [RUN_ID] AND status = 'running';
```

## Security Considerations

1. **No workflow modifications** - Workflows are blocked to prevent privilege escalation
2. **No database migrations** - Schema changes require manual review
3. **No secrets access** - Environment vars and secrets are read-only
4. **Audit trail** - Full history in database and GitHub Actions
5. **Human approval** - All PRs require manual review and approval
6. **Rollback capability** - Every action can be reverted

## Future Enhancements (Post-v0)

- Implement reflection logic (analyze recent changes, issues, user feedback)
- Implement proposal generation (use LLM to suggest improvements)
- Implement action execution (create PRs, issues, update configs)
- Add ML-based risk scoring
- Add automatic rollback on failure detection
- Add integration with monitoring/observability systems
- Add A/B testing for proposals
- Add user feedback collection

## Success Criteria (v0)

- ✅ Database schema created and migrated
- ✅ Workflow file functional
- ✅ Feature flag system working
- ✅ Safety rails configured
- ✅ PR template created
- ✅ Documentation complete
- ⏳ First auto-PR opens with zero policy violations (future iteration)
- ⏳ Diff caps enforced (future iteration)
- ⏳ Green CI required (future iteration)

## References

- Issue: #754
- PR: [TBD]
- Database Migration Script: `packages/database/scripts/create-self-evolution-tables.sh`
- Workflow: `.github/workflows/self-evolution.yml`
- Config: `.github/self-evolution-config.json`
- PR Template: `.github/PULL_REQUEST_TEMPLATE/self_evolution.md`

## Changelog

### v0.1.0 (2025-12-05)
- Initial infrastructure setup
- Database schema created
- Workflow and safety rails configured
- Feature flag system implemented
- Documentation written
