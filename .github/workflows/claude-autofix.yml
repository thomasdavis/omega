name: Claude Auto-Fix Trigger

on:
  workflow_run:
    workflows: ["CI"] # ← your CI workflow name
    types:
      - completed

jobs:
  tag_claude:
    runs-on: ubuntu-latest

    # Only run when CI fails
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      # -----------------------------
      # 1. Identify PR attached to CI
      # -----------------------------
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            const prs = await github.rest.actions.listWorkflowRunPullRequests({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
            });

            if (prs.data.length === 0) {
              core.setFailed("No PR associated with this workflow run.");
            }

            const pr = prs.data[0];
            core.setOutput("number", pr.number);
            core.setOutput("ref", pr.head.ref);

      # ----------------------------------------------
      # 2. Only target PRs created by Claude (claude/*)
      # ----------------------------------------------
      - name: Check if PR created by Claude
        id: claude_origin
        run: |
          BRANCH="${{ steps.pr.outputs.ref }}"
          if [[ "$BRANCH" == claude/* || "$BRANCH" == claude-* ]]; then
            echo "is_claude=true" >> $GITHUB_OUTPUT
          else
            echo "is_claude=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if PR is not from Claude
        if: steps.claude_origin.outputs.is_claude == 'false'
        run: echo "Skipping — not a Claude PR."

      # --------------------------------------------------------------
      # 3. Intelligent Retry Count (reads past comments on the PR)
      # --------------------------------------------------------------
      - name: Count existing Claude retry comments
        id: retry
        if: steps.claude_origin.outputs.is_claude == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const { owner, repo } = context.repo;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: prNumber }
            );

            const retryComments = comments.filter(c =>
              c.body.includes("[claude-retry]")
            );

            core.setOutput("count", retryComments.length);

      - name: Stop if Claude retry limit reached
        if: steps.retry.outputs.count >= 5
        run: echo "Max retries (5) reached — stopping further Claude triggers."

      # ----------------------------------------------------
      # 4. Extract failing build/lint jobs only + summarize
      # ----------------------------------------------------
      - name: Extract failing build/lint jobs
        id: failures
        if: steps.retry.outputs.count < 5
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
            });

            const failed = jobs.data.jobs.filter(
              (j) =>
                j.conclusion === "failure" &&
                (j.name.toLowerCase().includes("build") ||
                 j.name.toLowerCase().includes("lint"))
            );

            if (failed.length === 0) {
              core.setFailed("CI failed but not on build/lint.");
            }

            let summary = "";
            for (const job of failed) {
              summary += `### ❌ Job: ${job.name}\n\n`;
              summary += "**Failure summary:**\n```\n";
              summary += (job.steps?.map(s => `${s.conclusion}: ${s.name}`).join("\n") || "No step info");
              summary += "\n```\n\n";
            }

            core.setOutput("summary", summary);

      # ---------------------------------------------
      # 5. Post @claude comment with retry marker
      # ---------------------------------------------
      - name: Ask Claude to fix CI
        if: steps.retry.outputs.count < 5
        uses: actions/github-script@v7
        with:
          script: |
            const pr = ${{ steps.pr.outputs.number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const summary = `${{ steps.failures.outputs.summary }}`;
            const attempt = Number(${{ steps.retry.outputs.count }}) + 1;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr,
              body: `
[claude-retry] Attempt ${attempt} of 5

@claude please fix the failing CI checks.

The failing jobs were **build** or **lint**, and here is the summary:

${summary}

Use these logs to identify the issue, correct the code, and push a new commit.
`
            });
