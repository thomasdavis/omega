name: Claude - Create Pull Request

on:
  push:
    branches:
      - 'claude/**'

concurrency:
  group: claude-pr-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create-pull-request:
    name: Create Pull Request from Claude Branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Git for Bot
        uses: ./.github/actions/setup-git-bot

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_PAT }}
        run: |
          echo "::group::Checking for existing PR"
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Branch: $BRANCH_NAME"

          # Check if a PR already exists for this branch
          PR_COUNT=$(gh pr list --head "$BRANCH_NAME" --json number --jq 'length')

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "âœ… PR already exists: #$PR_NUMBER"
            echo "::notice::PR already exists: #$PR_NUMBER"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No existing PR found, will create one"
          fi
          echo "::endgroup::"

      - name: Extract issue number from branch
        if: steps.check-pr.outputs.exists == 'false'
        id: extract-issue
        run: |
          echo "::group::Extracting issue number"
          BRANCH_NAME="${{ steps.check-pr.outputs.branch }}"
          # Extract issue number from branch name like claude/issue-42-timestamp
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | sed -n 's/.*issue-\([0-9]\+\).*/\1/p')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ Could not extract issue number from branch name: $BRANCH_NAME"
            echo "number=" >> $GITHUB_OUTPUT
          else
            echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "âœ… Extracted issue number: #$ISSUE_NUMBER"
          fi
          echo "::endgroup::"

      - name: Fetch issue details
        if: steps.check-pr.outputs.exists == 'false' && steps.extract-issue.outputs.number != ''
        id: issue-details
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_PAT }}
        run: |
          echo "::group::Fetching issue details"
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.number }}"
          ISSUE_TITLE=$(gh issue view "$ISSUE_NUMBER" --json title --jq '.title')

          if [ -z "$ISSUE_TITLE" ]; then
            echo "âš ï¸ Could not fetch title for issue #$ISSUE_NUMBER"
            echo "title=Claude Code Implementation" >> $GITHUB_OUTPUT
          else
            # Sanitize: collapse newlines/backticks into spaces, truncate to 200 chars
            CLEAN_TITLE=$(echo "$ISSUE_TITLE" | tr '\n\r' '  ' | tr '`' "'" | sed 's/  */ /g' | head -c 200)
            echo "title=$CLEAN_TITLE" >> $GITHUB_OUTPUT
            echo "âœ… Issue title: $CLEAN_TITLE"
          fi
          echo "::endgroup::"

      - name: Setup Node.js and pnpm
        if: steps.check-pr.outputs.exists == 'false'
        uses: ./.github/actions/setup-node-pnpm

      - name: Merge main and resolve conflicts
        if: steps.check-pr.outputs.exists == 'false'
        continue-on-error: true
        run: |
          echo "::group::Merging main branch"
          echo "â„¹ï¸ Fetching latest main branch..."
          git fetch origin main

          echo "â„¹ï¸ Attempting to merge main into current branch..."
          if git merge origin/main --no-edit; then
            echo "âœ… Merged main successfully without conflicts"
          else
            echo "::warning::Merge conflicts detected, auto-resolving..."

            # Get list of conflicted files
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)

            if [ -n "$CONFLICTED_FILES" ]; then
              echo "âš ï¸ Conflicted files:"
              echo "$CONFLICTED_FILES"

              # Resolve conflicts by preferring Claude's changes (ours)
              for file in $CONFLICTED_FILES; do
                echo "ðŸ”§ Resolving conflict in $file (keeping Claude's version)..."
                git checkout --ours "$file"
                git add "$file"
              done

              # Complete the merge
              git commit --no-edit -m "Auto-resolve merge conflicts (prefer Claude's changes)"
              echo "âœ… Auto-resolved conflicts and committed"
            fi
          fi
          echo "::endgroup::"

      - name: Fix pnpm lockfile if needed
        if: steps.check-pr.outputs.exists == 'false'
        continue-on-error: true
        run: |
          echo "::group::Checking lockfile integrity"
          if [ -f "pnpm-lock.yaml" ]; then
            echo "â„¹ï¸ Checking pnpm lockfile integrity..."

            if pnpm install --frozen-lockfile 2>&1 | grep -q "ERR_PNPM"; then
              echo "::warning::Lockfile out of sync, regenerating..."
              pnpm install --no-frozen-lockfile

              if git diff --quiet pnpm-lock.yaml; then
                echo "âœ… Lockfile is now in sync"
              else
                echo "ðŸ”§ Committing updated lockfile..."
                git add pnpm-lock.yaml
                git commit -m "chore: fix pnpm lockfile"
                echo "âœ… Lockfile updated and committed"
              fi
            else
              echo "âœ… Lockfile is valid"
            fi
          fi
          echo "::endgroup::"

      - name: Push updates if any
        if: steps.check-pr.outputs.exists == 'false'
        continue-on-error: true
        run: |
          echo "::group::Pushing updates"
          if git diff --quiet origin/${{ steps.check-pr.outputs.branch }}; then
            echo "â„¹ï¸ No changes to push"
          else
            echo "ðŸ“¤ Pushing merge and lockfile updates..."
            git push origin HEAD
            echo "âœ… Pushed updates"
          fi
          echo "::endgroup::"

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_PAT }}
        run: |
          echo "::group::Creating pull request"
          BRANCH_NAME="${{ steps.check-pr.outputs.branch }}"
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.number }}"
          ISSUE_TITLE="${{ steps.issue-details.outputs.title }}"

          # Construct PR title
          if [ -n "$ISSUE_TITLE" ]; then
            PR_TITLE="$ISSUE_TITLE"
          else
            PR_TITLE="Claude Code Implementation"
          fi

          # Construct PR body
          PR_BODY="## ðŸ¤– Claude Code Implementation

          This PR was automatically created by the Omega self-evolving bot workflow.

          "

          if [ -n "$ISSUE_NUMBER" ]; then
            PR_BODY="${PR_BODY}Fixes #${ISSUE_NUMBER}

          "
          fi

          PR_BODY="${PR_BODY}### Changes

          Claude Code has implemented the requested feature on the \`${BRANCH_NAME}\` branch.

          ### Next Steps

          - â³ CI checks will run (type check, lint, build)
          - âœ… Auto-merge will be enabled automatically if all checks pass
          - ðŸ”§ If checks fail, @claude will be tagged to fix the issues
          - ðŸš€ Deployment will trigger after merge

          ---

          ðŸ¤– Generated by Omega Bot"

          # Create the PR
          echo "ðŸ“ Creating pull request..."
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME")

          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]*$')

          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… Created PR #$PR_NUMBER"
          echo "::notice::Created PR #$PR_NUMBER: $PR_URL"
          echo "::endgroup::"

      - name: Notify Discord of PR creation
        if: steps.check-pr.outputs.exists == 'false' && steps.create-pr.outputs.url != ''
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "::group::Sending Discord notification"
          PR_URL="${{ steps.create-pr.outputs.url }}"
          PR_NUMBER="${{ steps.create-pr.outputs.number }}"
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.number }}"
          ISSUE_TITLE="${{ steps.issue-details.outputs.title }}"

          TITLE="ðŸ”€ Pull Request Created"

          if [ -n "$ISSUE_TITLE" ]; then
            DESCRIPTION="**$ISSUE_TITLE**"
          else
            DESCRIPTION="Claude Code has created a new pull request"
          fi

          FIELDS=""
          if [ -n "$ISSUE_NUMBER" ]; then
            FIELDS="\"fields\": [{\"name\": \"Related Issue\", \"value\": \"#$ISSUE_NUMBER\", \"inline\": true}],"
          fi

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"description\": \"$DESCRIPTION\",
                \"color\": 3447003,
                $FIELDS
                \"fields\": [
                  {\"name\": \"Pull Request\", \"value\": \"[#$PR_NUMBER]($PR_URL)\", \"inline\": true},
                  {\"name\": \"Status\", \"value\": \"CI checks running â³\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Omega Bot\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" && echo "âœ… Discord notification sent" || echo "::warning::Failed to send Discord notification"
          echo "::endgroup::"

      - name: Workflow Summary
        if: always()
        run: |
          echo "::group::Workflow Summary"
          echo "## ðŸ¤– Claude PR Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-pr.outputs.exists }}" == "true" ]; then
            echo "âœ… **PR Already Exists**: #${{ steps.check-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No action needed - PR was already created previously." >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.create-pr.outputs.url }}" ]; then
            echo "âœ… **PR Created Successfully**: #${{ steps.create-pr.outputs.number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**URL**: ${{ steps.create-pr.outputs.url }}" >> $GITHUB_STEP_SUMMARY

            if [ -n "${{ steps.extract-issue.outputs.number }}" ]; then
              echo "**Related Issue**: #${{ steps.extract-issue.outputs.number }}" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. â³ CI checks will run" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… Auto-merge if checks pass" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ”§ @claude tagged if checks fail" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸš€ Auto-deploy after merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **PR Creation Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"
