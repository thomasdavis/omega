name: Auto-Merge Claude PRs

on:
  workflow_run:
    workflows: ["CI Checks"]
    types:
      - completed

jobs:
  auto-merge:
    name: Enable Auto-Merge After CI Passes
    runs-on: ubuntu-latest

    # Only run if CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });

            if (pulls.data.length === 0) {
              console.log('No open PR found for this branch');
              return;
            }

            const pr = pulls.data[0];
            core.setOutput('number', pr.number);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('body', pr.body || '');

      - name: Check if Claude PR
        id: check_claude
        if: steps.pr.outputs.number != ''
        run: |
          HEAD_REF="${{ steps.pr.outputs.head_ref }}"
          if [[ "$HEAD_REF" == claude/* ]]; then
            echo "is_claude=true" >> $GITHUB_OUTPUT
          else
            echo "is_claude=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR is linked to an issue
        id: check_issue
        if: steps.check_claude.outputs.is_claude == 'true'
        env:
          PR_BODY: ${{ steps.pr.outputs.body }}
        run: |
          if echo "$PR_BODY" | grep -qiE "(fixes|closes|resolves) #[0-9]+"; then
            echo "linked=true" >> $GITHUB_OUTPUT
          else
            echo "linked=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge PR
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          echo "‚úÖ CI checks passed! Merging PR #$PR_NUMBER..."

          gh pr merge "$PR_NUMBER" \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch

          echo "‚úÖ PR #$PR_NUMBER merged successfully!"

      - name: Checkout repository
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Install dependencies
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build agent package
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        run: pnpm build --filter=@repo/agent

      - name: Generate Comic
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          PR_TITLE: ${{ steps.pr.outputs.head_ref }}
          PR_AUTHOR: ${{ github.actor }}
          PR_URL: https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.number }}
          # Twitter credentials (optional - workflow continues if not set)
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          cd apps/bot
          npx tsx scripts/generate-pr-comic.ts || echo "Comic generation failed, but continuing..."

      - name: Commit Comic to Repository
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        continue-on-error: true
        run: |
          # Check if any comics were generated
          if [ -d "apps/bot/public/comics" ] && [ "$(ls -A apps/bot/public/comics)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Add all comics
            git add apps/bot/public/comics/*.png

            # Check if there are changes to commit
            if ! git diff --cached --quiet; then
              git commit -m "feat: Add generated comic for PR #${{ steps.pr.outputs.number }}

              Comic generated via Gemini API and posted to Discord.

              ü§ñ Generated by Omega Bot"

              # Pull with rebase to avoid conflicts, then push
              git pull --rebase origin main || {
                echo "‚ö†Ô∏è  Rebase failed, aborting push"
                git rebase --abort
                exit 1
              }

              git push origin main
              echo "‚úÖ Comic committed to repository"
            else
              echo "‚ÑπÔ∏è  No new comics to commit"
            fi
          else
            echo "‚ö†Ô∏è  No comics directory or no comics generated"
          fi

      - name: Comment on PR
        if: steps.check_claude.outputs.is_claude == 'true' && steps.check_issue.outputs.linked == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: '‚úÖ **CI checks passed!** This PR has been automatically merged and deployed.'
            });
