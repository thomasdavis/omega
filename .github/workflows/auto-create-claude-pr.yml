name: Auto-Create Claude Code PR

on:
  push:
    branches:
      - 'claude/**'

jobs:
  create-pr:
    name: Create PR from Claude Code branch
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Auto-resolve merge conflicts with main
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch latest main
          git fetch origin main

          # Try to merge main into current branch
          if ! git merge origin/main --no-edit; then
            echo "‚ö†Ô∏è Merge conflicts detected, auto-resolving by preferring this branch's changes..."

            # Get list of conflicted files
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)

            # For each conflicted file, prefer our version (the Claude branch)
            for file in $CONFLICTED_FILES; do
              echo "Resolving conflict in $file by preferring Claude's changes"
              git checkout --theirs "$file"
              git add "$file"
            done

            # Commit the merge
            git commit -m "Auto-resolve merge conflicts: prefer latest implementation from Claude Code"

            # Push the resolved branch
            git push origin "$BRANCH_NAME"

            echo "‚úÖ Conflicts resolved and pushed"
          else
            echo "‚úÖ No conflicts, branch is up to date with main"
          fi

      - name: Extract issue number from branch name
        id: extract_issue
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Extract issue number from branch name (format: claude/issue-N-...)
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE "issue-([0-9]+)" | grep -oE "[0-9]+")
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

          if [ -z "$ISSUE_NUM" ]; then
            echo "Could not extract issue number from branch: $BRANCH_NAME"
            exit 1
          fi

      - name: Get issue details
        id: issue_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ steps.extract_issue.outputs.issue_number }}"

          # Get issue title
          ISSUE_TITLE=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUM --jq '.title')
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${{ steps.extract_issue.outputs.branch_name }}"

          # Check if a PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number // ""')

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "PR #$EXISTING_PR already exists for branch $BRANCH_NAME"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found for branch $BRANCH_NAME"
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists == 'false'
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ steps.extract_issue.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue_details.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.extract_issue.outputs.branch_name }}"

          # Create the PR body
          PR_BODY="## Summary
          Automated implementation by Claude Code for issue #${ISSUE_NUM}.

          ## Changes
          See individual commits for details of changes made.

          Fixes #${ISSUE_NUM}

          ---

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)"

          # Create the PR and capture URL
          PR_URL=$(gh pr create \
            --title "$ISSUE_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME")

          echo "‚úÖ Created PR: $PR_URL"

          # Extract PR number from URL
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "‚úÖ Created PR #$PR_NUMBER for branch $BRANCH_NAME"

      - name: Enable auto-merge
        if: steps.check_pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"

          # Wait for PR to be ready and enable auto-merge with retry
          echo "‚è≥ Waiting for PR to be ready..."
          MAX_ATTEMPTS=10
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            if gh pr merge "$PR_NUMBER" \
              --repo ${{ github.repository }} \
              --auto \
              --squash \
              --delete-branch 2>&1; then
              echo "‚úÖ Auto-merge enabled for PR #$PR_NUMBER"

              # Add comment to PR
              gh pr comment "$PR_NUMBER" \
                --repo ${{ github.repository }} \
                --body "ü§ñ Auto-merge enabled! This PR will be merged automatically when all checks pass."

              exit 0
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚è≥ PR not ready yet, waiting 3 seconds..."
              sleep 3
            fi
          done

          echo "‚ùå Failed to enable auto-merge after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Comment on existing PR
        if: steps.check_pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "PR already exists, skipping creation"
