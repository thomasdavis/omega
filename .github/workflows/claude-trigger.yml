name: Claude - Trigger Entry Point

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, labeled]
  pull_request:
    types: [labeled]

jobs:
  trigger-claude-code:
    name: Trigger Claude Code
    runs-on: ubuntu-latest

    # Run if comment contains @claude OR issue body contains @claude OR label is claude-fix-needed OR database label added
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'database') ||
      (github.event_name == 'pull_request' && github.event.label.name == 'claude-fix-needed')

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log trigger information
        run: |
          echo "::group::Trigger Information"
          echo "ðŸ“‹ Event: ${{ github.event_name }}"
          echo "ðŸ“‹ Action: ${{ github.event.action }}"
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "ðŸ“ Comment on issue/PR #${{ github.event.issue.number }}"
            echo "ðŸ‘¤ By: ${{ github.event.comment.user.login }}"
          elif [ "${{ github.event_name }}" == "pull_request_review_comment" ]; then
            echo "ðŸ“ Review comment on PR #${{ github.event.pull_request.number }}"
            echo "ðŸ‘¤ By: ${{ github.event.comment.user.login }}"
          elif [ "${{ github.event_name }}" == "issues" ] && [ "${{ github.event.action }}" == "opened" ]; then
            echo "ðŸ†• New issue #${{ github.event.issue.number }}"
            echo "ðŸ‘¤ By: ${{ github.event.issue.user.login }}"
          elif [ "${{ github.event_name }}" == "issues" ] && [ "${{ github.event.action }}" == "labeled" ]; then
            echo "ðŸ·ï¸ Label added to issue #${{ github.event.issue.number }}"
            echo "ðŸ·ï¸ Label: ${{ github.event.label.name }}"
            if [ "${{ github.event.label.name }}" == "database" ]; then
              echo "ðŸ—„ï¸ Database migration issue detected!"
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ðŸ·ï¸ Label added to PR #${{ github.event.pull_request.number }}"
            echo "ðŸ·ï¸ Label: ${{ github.event.label.name }}"
          fi
          echo "::notice::Claude Code triggered via ${{ github.event_name }}"
          echo "::endgroup::"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Execution Summary
        if: always()
        run: |
          echo "::group::Execution Summary"
          echo "## ðŸ¤– Claude Code Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.claude.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.claude.outcome }}" == "success" ]; then
            echo "âœ… Claude Code executed successfully" >> $GITHUB_STEP_SUMMARY
            echo "::notice::Claude Code completed successfully"
          else
            echo "âš ï¸ Claude Code execution had issues" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Claude Code execution had issues"
          fi
          echo "::endgroup::"
