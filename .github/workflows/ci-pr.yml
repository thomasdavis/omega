name: CI - Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/**/*.ts'
      - 'apps/**/*.tsx'
      - 'apps/**/*.js'
      - 'apps/**/*.jsx'
      - 'packages/**/*.ts'
      - 'packages/**/*.tsx'
      - 'packages/**/*.js'
      - 'packages/**/*.jsx'
      - '**/package.json'
      - '**/tsconfig.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.github/workflows/ci-pr.yml'

# Allow only one concurrent CI run per PR
concurrency:
  group: ci-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  run-pr-checks:
    name: Run PR CI Checks
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git for Bot
        uses: ./.github/actions/setup-git-bot

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dependencies (with lockfile auto-fix)
        id: install
        run: |
          echo "::group::Installing dependencies"
          echo "â„¹ï¸ PR #${{ github.event.pull_request.number }}"
          echo "â„¹ï¸ Branch: ${{ github.event.pull_request.head.ref }}"

          echo "ðŸ“¦ Attempting install with frozen lockfile..."
          if pnpm install --frozen-lockfile 2>&1 | tee install-output.txt; then
            echo "âœ… Lockfile is in sync"
            echo "lockfile_fixed=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Lockfile out of sync, regenerating..."
            echo "lockfile_fixed=true" >> $GITHUB_OUTPUT

            # Regenerate lockfile
            pnpm install --no-frozen-lockfile

            # Check if lockfile was modified
            if git diff --quiet pnpm-lock.yaml; then
              echo "â„¹ï¸ No lockfile changes needed after all"
              echo "lockfile_fixed=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Lockfile regenerated successfully"

              # Commit and push the updated lockfile
              git add pnpm-lock.yaml
              git commit -m "chore: auto-fix pnpm lockfile" -m "Lockfile was out of sync with package.json changes." -m "Auto-fixed by CI workflow." -m "ðŸ¤– Generated by GitHub Actions"
              git push origin HEAD:${{ github.event.pull_request.head.ref }}
              echo "âœ… Lockfile committed and pushed"
              echo "::notice::Lockfile auto-fixed and pushed to PR #${{ github.event.pull_request.number }}"
            fi
          fi
          echo "::endgroup::"

      - name: Comment on lockfile fix
        if: steps.install.outputs.lockfile_fixed == 'true' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Posting lockfile fix comment"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "â„¹ï¸ Commenting on PR #$PR_NUMBER"

          gh pr comment "$PR_NUMBER" --body "ðŸ”§ **Lockfile Auto-Fixed**

          The \`pnpm-lock.yaml\` was out of sync with \`package.json\` changes.

          âœ… Automatically regenerated and committed the lockfile.
          ðŸ”„ CI checks will re-run with the updated lockfile."

          echo "âœ… Comment posted"
          echo "::endgroup::"

      - name: Run type check
        id: typecheck
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "::group::Running type check"
          echo "â„¹ï¸ Running TypeScript type check in apps/bot"
          pnpm run type-check 2>&1 | tee typecheck-output.txt
          RESULT=${PIPESTATUS[0]}

          if [ $RESULT -eq 0 ]; then
            echo "âœ… Type check passed"
          else
            echo "âŒ Type check failed"
          fi
          echo "::endgroup::"
          exit $RESULT

      - name: Run lint
        id: lint
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "::group::Running lint"
          echo "â„¹ï¸ Running ESLint in apps/bot"
          pnpm run lint 2>&1 | tee lint-output.txt
          RESULT=${PIPESTATUS[0]}

          if [ $RESULT -eq 0 ]; then
            echo "âœ… Lint passed"
          else
            echo "âŒ Lint failed"
          fi
          echo "::endgroup::"
          exit $RESULT

      - name: Build check
        id: build
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "::group::Running build"
          echo "â„¹ï¸ Running build in apps/bot"
          pnpm run build 2>&1 | tee build-output.txt
          RESULT=${PIPESTATUS[0]}

          if [ $RESULT -eq 0 ]; then
            echo "âœ… Build passed"
          else
            echo "âŒ Build failed"
          fi
          echo "::endgroup::"
          exit $RESULT

      - name: Determine overall status
        id: status
        run: |
          echo "::group::Determining overall CI status"
          TYPECHECK_STATUS="${{ steps.typecheck.outcome }}"
          LINT_STATUS="${{ steps.lint.outcome }}"
          BUILD_STATUS="${{ steps.build.outcome }}"

          echo "typecheck=$TYPECHECK_STATUS" >> $GITHUB_OUTPUT
          echo "lint=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "build=$BUILD_STATUS" >> $GITHUB_OUTPUT

          echo "â„¹ï¸ Type check: $TYPECHECK_STATUS"
          echo "â„¹ï¸ Lint: $LINT_STATUS"
          echo "â„¹ï¸ Build: $BUILD_STATUS"

          if [ "$TYPECHECK_STATUS" == "success" ] && [ "$LINT_STATUS" == "success" ] && [ "$BUILD_STATUS" == "success" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All checks passed!"
            echo "::notice::All CI checks passed for PR #${{ github.event.pull_request.number }}"
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Some checks failed"
            echo "::warning::Some CI checks failed for PR #${{ github.event.pull_request.number }}"
          fi
          echo "::endgroup::"

      - name: Tag Claude to fix failures
        if: steps.status.outputs.all_passed == 'false' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_PAT }}
        run: |
          echo "::group::Tagging Claude to fix failures"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "â„¹ï¸ PR #$PR_NUMBER has failures, tagging @claude"

          # Collect error messages
          ERRORS=""

          if [ "${{ steps.typecheck.outcome }}" != "success" ]; then
            echo "ðŸ“‹ Collecting type check errors"
            ERRORS="${ERRORS}### ðŸ”´ Type Check Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/typecheck-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          if [ "${{ steps.lint.outcome }}" != "success" ]; then
            echo "ðŸ“‹ Collecting lint errors"
            ERRORS="${ERRORS}### ðŸ”´ Lint Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/lint-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          if [ "${{ steps.build.outcome }}" != "success" ]; then
            echo "ðŸ“‹ Collecting build errors"
            ERRORS="${ERRORS}### ðŸ”´ Build Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/build-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          # Create comment tagging Claude (using PAT so it counts as user, not bot)
          COMMENT_BODY="@claude The CI checks have failed. Please fix the following issues:

          ${ERRORS}

          **Instructions:**
          1. Review the error messages above
          2. Fix all type errors, lint issues, and build failures
          3. Test the fixes locally with \`pnpm type-check\`, \`pnpm lint\`, and \`pnpm build\`
          4. Commit and push the fixes to this PR branch

          Once all checks pass, this PR will automatically merge."

          gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"

          # Also add a label to trigger workflows
          gh pr edit "$PR_NUMBER" --add-label "claude-fix-needed"

          echo "âœ… Tagged @claude to fix CI failures"
          echo "::notice::Tagged @claude on PR #$PR_NUMBER to fix failures"
          echo "::endgroup::"

      - name: Comment success on PR
        if: steps.status.outputs.all_passed == 'true' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Posting success comment"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "â„¹ï¸ Commenting success on PR #$PR_NUMBER"

          gh pr comment "$PR_NUMBER" --body "âœ… **All CI checks passed!**

          - âœ… Type check passed
          - âœ… Lint passed
          - âœ… Build passed

          This PR is ready to merge automatically."

          echo "âœ… Success comment posted"
          echo "::endgroup::"

      - name: Final status check
        if: steps.status.outputs.all_passed == 'false'
        run: |
          echo "::group::Final status"
          echo "âŒ CI checks failed. Marking workflow as failed."
          echo "::error::One or more CI checks failed - see logs above"
          echo "::endgroup::"
          exit 1

      - name: Workflow Summary
        if: always()
        run: |
          echo "::group::Workflow Summary"
          echo "## ðŸ” PR CI Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.install.outputs.lockfile_fixed }}" == "true" ]; then
            echo "ðŸ”§ **Lockfile:** Auto-fixed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Lockfile:** In sync" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.typecheck.outcome }}" == "success" ]; then
            echo "- âœ… **Type Check:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Type Check:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.lint.outcome }}" == "success" ]; then
            echo "- âœ… **Lint:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Lint:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "- âœ… **Build:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Build:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.status.outputs.all_passed }}" == "true" ]; then
            echo "### âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
            echo "This PR is ready to merge ðŸš€" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "Review the logs above for error details." >> $GITHUB_STEP_SUMMARY

            if [[ "${{ github.event.pull_request.head.ref }}" == claude/* ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ¤– @claude has been tagged to fix the issues." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "::endgroup::"
