name: Comic - Generate on Merge

on:
  pull_request:
    types: [closed]

jobs:
  generate-and-post-comic:
    name: Generate and Post Comic
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dependencies
        run: |
          echo "::group::Installing dependencies"
          pnpm install --frozen-lockfile
          echo "::endgroup::"

      - name: Generate comic and post to Discord + Twitter
        id: generate
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          OMEGA_API_URL: ${{ secrets.OMEGA_API_URL || 'https://omega-vu7a.onrailway.app' }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          echo "::group::Generating comic for PR #${{ github.event.pull_request.number }}"
          echo "â„¹ï¸ PR: ${{ github.event.pull_request.title }}"
          echo "â„¹ï¸ Author: ${{ github.event.pull_request.user.login }}"
          cd apps/bot
          npx tsx scripts/generate-pr-comic.ts
          echo "::endgroup::"

      - name: Upload comic as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ github.event.pull_request.number }}-comic
          path: apps/bot/comics/*.png
          retention-days: 30
          if-no-files-found: warn

      - name: Comment on PR with result
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const resultPath = 'apps/bot/comic-result.json';

            let comment = 'ðŸŽ¨ **Comic Generation Complete**\n\n';

            if (fs.existsSync(resultPath)) {
              const result = JSON.parse(fs.readFileSync(resultPath, 'utf8'));

              if (result.success) {
                comment += `âœ… Successfully generated and posted comic!\n\n`;
                comment += `ðŸ“Š Image size: ${(result.imageSize / 1024).toFixed(2)} KB\n`;
                if (result.discordMessageId) {
                  comment += `ðŸ’¬ Discord Message ID: \`${result.discordMessageId}\`\n`;
                }
                if (result.twitterPostUrl) {
                  comment += `ðŸ¦ Twitter: ${result.twitterPostUrl}\n`;
                }
                if (result.comicPath) {
                  comment += `ðŸ“ Saved to: \`${result.comicPath}\`\n`;
                }
              } else {
                comment += `âŒ Failed to generate comic: ${result.error}\n\n`;
                comment += `Please check the workflow logs for more details.`;
              }
            } else {
              comment += 'âŒ Comic generation script did not complete properly.\n';
              comment += 'Check the workflow logs for error details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Workflow Summary
        if: always()
        run: |
          echo "::group::Comic Generation Summary"
          echo "## ðŸŽ¨ Comic Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.generate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "apps/bot/comic-result.json" ]; then
            cat apps/bot/comic-result.json | jq '.' >> $GITHUB_STEP_SUMMARY || echo "Result file exists but could not be parsed"
          else
            echo "âŒ No result file generated" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.generate.outcome }}" == "success" ]; then
            echo "::notice::Comic generated successfully for PR #${{ github.event.pull_request.number }}"
          else
            echo "::warning::Comic generation had issues for PR #${{ github.event.pull_request.number }}"
          fi
          echo "::endgroup::"
