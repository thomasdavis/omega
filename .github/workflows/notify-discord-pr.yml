name: Notify - Discord PR Events

on:
  pull_request:
    types: [opened, closed]

jobs:
  notify-pr-created:
    name: Notify PR Created
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.pull_request.user.login == 'claude-code[bot]'

    steps:
      - name: Extract issue number from PR body
        id: extract_issue
        run: |
          echo "::group::Extracting issue number"
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE "(fixes|closes|resolves) #([0-9]+)" | grep -oE "[0-9]+" | head -1)
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Extracted issue number: #$ISSUE_NUM"
          echo "::endgroup::"

      - name: Send Discord notification
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "ðŸ“ Claude Code Created PR"
          embed-description: |
            **PR #${{ github.event.pull_request.number }}:** ${{ github.event.pull_request.title }}
            **Issue:** #${{ steps.extract_issue.outputs.issue_number }}
            **Branch:** `${{ github.event.pull_request.head.ref }}`

            Claude Code has created a pull request to implement this feature.

            [View PR](${{ github.event.pull_request.html_url }})
          embed-color: 3447003
          embed-url: ${{ github.event.pull_request.html_url }}

      - name: Notification Summary
        run: |
          echo "::group::Notification Summary"
          echo "## ðŸ“¢ Discord Notification Sent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** PR Created" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** #${{ steps.extract_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "::notice::Discord notified of PR #${{ github.event.pull_request.number }} creation"
          echo "::endgroup::"

  notify-pr-merged:
    name: Notify PR Merged
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event.pull_request.merged == true

    steps:
      - name: Extract issue number from PR body
        id: extract_issue
        run: |
          echo "::group::Extracting issue number"
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE "(fixes|closes|resolves) #([0-9]+)" | grep -oE "[0-9]+" | head -1)
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Extracted issue number: #$ISSUE_NUM"
          echo "::endgroup::"

      - name: Get commit info
        id: commit
        run: |
          echo "::group::Getting commit info"
          echo "sha=$(echo ${{ github.event.pull_request.merge_commit_sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Merge commit: $(echo ${{ github.event.pull_request.merge_commit_sha }} | cut -c1-7)"
          echo "::endgroup::"

      - name: Send Discord notification
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "âœ… PR Merged Successfully"
          embed-description: |
            **PR #${{ github.event.pull_request.number }}:** ${{ github.event.pull_request.title }}
            **Issue #${{ steps.extract_issue.outputs.issue_number }}** has been closed
            **Merged by:** ${{ github.event.pull_request.merged_by.login }}
            **Commit:** `${{ steps.commit.outputs.sha }}`

            Changes are being deployed to Railway...

            [View PR](${{ github.event.pull_request.html_url }})
          embed-color: 3066993
          embed-url: ${{ github.event.pull_request.html_url }}

      - name: Notification Summary
        run: |
          echo "::group::Notification Summary"
          echo "## ðŸ“¢ Discord Notification Sent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** PR Merged" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** #${{ steps.extract_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged by:** ${{ github.event.pull_request.merged_by.login }}" >> $GITHUB_STEP_SUMMARY
          echo "::notice::Discord notified of PR #${{ github.event.pull_request.number }} merge"
          echo "::endgroup::"
