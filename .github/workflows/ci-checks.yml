name: CI Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/bot/**/*.ts'
      - 'apps/bot/**/*.tsx'
      - 'apps/bot/**/*.js'
      - 'apps/bot/**/*.jsx'
      - 'apps/bot/package.json'
      - 'apps/bot/tsconfig.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/ci-checks.yml'

# Allow only one concurrent CI run per PR
concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type check
        id: typecheck
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "Running TypeScript type check..."
          pnpm run type-check 2>&1 | tee typecheck-output.txt
          exit ${PIPESTATUS[0]}

      - name: Run lint
        id: lint
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "Running ESLint..."
          pnpm run lint 2>&1 | tee lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Build check
        id: build
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "Running build..."
          pnpm run build 2>&1 | tee build-output.txt
          exit ${PIPESTATUS[0]}

      - name: Determine overall status
        id: status
        run: |
          TYPECHECK_STATUS="${{ steps.typecheck.outcome }}"
          LINT_STATUS="${{ steps.lint.outcome }}"
          BUILD_STATUS="${{ steps.build.outcome }}"

          echo "typecheck=$TYPECHECK_STATUS" >> $GITHUB_OUTPUT
          echo "lint=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "build=$BUILD_STATUS" >> $GITHUB_OUTPUT

          if [ "$TYPECHECK_STATUS" == "success" ] && [ "$LINT_STATUS" == "success" ] && [ "$BUILD_STATUS" == "success" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All checks passed!"
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Some checks failed"
          fi

      - name: Tag Claude to fix failures
        if: steps.status.outputs.all_passed == 'false' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Collect error messages
          ERRORS=""

          if [ "${{ steps.typecheck.outcome }}" != "success" ]; then
            ERRORS="${ERRORS}### ðŸ”´ Type Check Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/typecheck-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          if [ "${{ steps.lint.outcome }}" != "success" ]; then
            ERRORS="${ERRORS}### ðŸ”´ Lint Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/lint-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          if [ "${{ steps.build.outcome }}" != "success" ]; then
            ERRORS="${ERRORS}### ðŸ”´ Build Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/build-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          # Create comment tagging Claude
          COMMENT_BODY="@claude The CI checks have failed. Please fix the following issues:

          ${ERRORS}

          **Instructions:**
          1. Review the error messages above
          2. Fix all type errors, lint issues, and build failures
          3. Test the fixes locally with \`pnpm type-check\`, \`pnpm lint\`, and \`pnpm build\`
          4. Commit and push the fixes to this PR branch

          Once all checks pass, this PR will automatically merge."

          gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"

          echo "âœ… Tagged @claude to fix CI failures"

      - name: Comment success on PR
        if: steps.status.outputs.all_passed == 'true' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          gh pr comment "$PR_NUMBER" --body "âœ… **All CI checks passed!**

          - âœ… Type check passed
          - âœ… Lint passed
          - âœ… Build passed

          This PR is ready to merge automatically."

      - name: Final status check
        if: steps.status.outputs.all_passed == 'false'
        run: |
          echo "âŒ CI checks failed. Marking workflow as failed."
          exit 1

      - name: Success summary
        if: steps.status.outputs.all_passed == 'true'
        run: |
          echo "## âœ… CI Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Type check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Ready to merge ðŸš€" >> $GITHUB_STEP_SUMMARY
