name: PR CI Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'apps/**/*.ts'
      - 'apps/**/*.tsx'
      - 'apps/**/*.js'
      - 'apps/**/*.jsx'
      - 'packages/**/*.ts'
      - 'packages/**/*.tsx'
      - 'packages/**/*.js'
      - 'packages/**/*.jsx'
      - '**/package.json'
      - '**/tsconfig.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.github/workflows/ci-checks.yml'

# Allow only one concurrent CI run per PR
concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Install dependencies (with lockfile auto-fix)
        id: install
        run: |
          echo "Attempting install with frozen lockfile..."
          if pnpm install --frozen-lockfile 2>&1 | tee install-output.txt; then
            echo "âœ… Lockfile is in sync"
            echo "lockfile_fixed=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Lockfile out of sync, regenerating..."
            echo "lockfile_fixed=true" >> $GITHUB_OUTPUT

            # Regenerate lockfile
            pnpm install --no-frozen-lockfile

            # Check if lockfile was modified
            if git diff --quiet pnpm-lock.yaml; then
              echo "â„¹ï¸  No lockfile changes needed after all"
              echo "lockfile_fixed=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Lockfile regenerated successfully"

              # Commit and push the updated lockfile
              git add pnpm-lock.yaml
              git commit -m "chore: auto-fix pnpm lockfile" -m "Lockfile was out of sync with package.json changes." -m "Auto-fixed by CI workflow." -m "ðŸ¤– Generated by GitHub Actions"
              git push origin HEAD:${{ github.event.pull_request.head.ref }}
              echo "âœ… Lockfile committed and pushed"
            fi
          fi

      - name: Comment on lockfile fix
        if: steps.install.outputs.lockfile_fixed == 'true' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          gh pr comment "$PR_NUMBER" --body "ðŸ”§ **Lockfile Auto-Fixed**

The \`pnpm-lock.yaml\` was out of sync with \`package.json\` changes.

âœ… Automatically regenerated and committed the lockfile.
ðŸ”„ CI checks will re-run with the updated lockfile."

      - name: Run type check
        id: typecheck
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "Running TypeScript type check..."
          pnpm run type-check 2>&1 | tee typecheck-output.txt
          exit ${PIPESTATUS[0]}

      - name: Run lint
        id: lint
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "Running ESLint..."
          pnpm run lint 2>&1 | tee lint-output.txt
          exit ${PIPESTATUS[0]}

      - name: Build check
        id: build
        continue-on-error: true
        working-directory: apps/bot
        run: |
          echo "Running build..."
          pnpm run build 2>&1 | tee build-output.txt
          exit ${PIPESTATUS[0]}

      - name: Determine overall status
        id: status
        run: |
          TYPECHECK_STATUS="${{ steps.typecheck.outcome }}"
          LINT_STATUS="${{ steps.lint.outcome }}"
          BUILD_STATUS="${{ steps.build.outcome }}"

          echo "typecheck=$TYPECHECK_STATUS" >> $GITHUB_OUTPUT
          echo "lint=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "build=$BUILD_STATUS" >> $GITHUB_OUTPUT

          if [ "$TYPECHECK_STATUS" == "success" ] && [ "$LINT_STATUS" == "success" ] && [ "$BUILD_STATUS" == "success" ]; then
            echo "all_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All checks passed!"
          else
            echo "all_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Some checks failed"
          fi

      - name: Tag Claude to fix failures
        if: steps.status.outputs.all_passed == 'false' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_PAT }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Collect error messages
          ERRORS=""

          if [ "${{ steps.typecheck.outcome }}" != "success" ]; then
            ERRORS="${ERRORS}### ðŸ”´ Type Check Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/typecheck-output.txt | tail-50)\n\`\`\`\n\n"
          fi

          if [ "${{ steps.lint.outcome }}" != "success" ]; then
            ERRORS="${ERRORS}### ðŸ”´ Lint Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/lint-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          if [ "${{ steps.build.outcome }}" != "success" ]; then
            ERRORS="${ERRORS}### ðŸ”´ Build Failed\n\n"
            ERRORS="${ERRORS}\`\`\`\n$(cat apps/bot/build-output.txt | tail -50)\n\`\`\`\n\n"
          fi

          # Create comment tagging Claude (using PAT so it counts as user, not bot)
          COMMENT_BODY="@claude The CI checks have failed. Please fix the following issues:

          ${ERRORS}

          **Instructions:**
          1. Review the error messages above
          2. Fix all type errors, lint issues, and build failures
          3. Test the fixes locally with \`pnpm type-check\`, \`pnpm lint\`, and \`pnpm build\`
          4. Commit and push the fixes to this PR branch

          Once all checks pass, this PR will automatically merge."

          gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"

          # Also add a label to trigger workflows
          gh pr edit "$PR_NUMBER" --add-label "claude-fix-needed"

          echo "âœ… Tagged @claude to fix CI failures"

      - name: Comment success on PR
        if: steps.status.outputs.all_passed == 'true' && startsWith(github.event.pull_request.head.ref, 'claude/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          gh pr comment "$PR_NUMBER" --body "âœ… **All CI checks passed!**

          - âœ… Type check passed
          - âœ… Lint passed
          - âœ… Build passed

          This PR is ready to merge automatically."

      - name: Final status check
        if: steps.status.outputs.all_passed == 'false'
        run: |
          echo "âŒ CI checks failed. Marking workflow as failed."
          exit 1

      - name: Success summary
        if: steps.status.outputs.all_passed == 'true'
        run: |
          echo "## âœ… CI Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Type check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Ready to merge ðŸš€" >> $GITHUB_STEP_SUMMARY
